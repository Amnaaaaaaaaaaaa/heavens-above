name: Dependency Updates

on:
  schedule:
    - cron: '0 9 * * 1'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  check-updates:
    name: Check for Dependency Updates
    runs-on: ubuntu-latest
    outputs:
      has-updates: ${{ steps.check.outputs.updates }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install npm-check-updates
        run: npm install -g npm-check-updates

      - name: Check for outdated packages
        id: check
        run: |
          ncu --jsonUpgraded > updates.json
          if [ -s updates.json ]; then
            echo "updates=true" >> $GITHUB_OUTPUT
            echo "Updates available"
          else
            echo "updates=false" >> $GITHUB_OUTPUT
            echo "All packages up to date"
          fi

      - name: Upload updates report
        if: steps.check.outputs.updates == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: dependency-updates
          path: updates.json

  update-minor-patches:
    name: Update Minor and Patch Versions
    runs-on: ubuntu-latest
    needs: check-updates
    if: needs.check-updates.outputs.has-updates == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install npm-check-updates
        run: npm install -g npm-check-updates

      - name: Update minor and patch versions
        run: |
          ncu -u --target minor
          npm install

      - name: Run tests
        run: npm test
        continue-on-error: true

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore(deps): update minor and patch dependencies'
          title: 'Automated Dependency Updates - Minor & Patches'
          body: |
            ## Automated Dependency Updates
            
            This PR contains automated updates for minor and patch version dependencies.
            
            ### Changes
            - Updated packages to latest minor/patch versions
            - All tests have been executed
            
            ### Checklist
            - [x] Dependencies updated
            - [x] Tests executed
            - [ ] Manual review required
            
            **Generated by GitHub Actions**
          branch: automated-dependency-updates-minor
          delete-branch: true
          labels: dependencies, automated

  security-updates:
    name: Apply Security Updates
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Run npm audit fix
        run: |
          npm audit fix --audit-level=moderate
          
      - name: Install and run Snyk
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          npm install -g snyk
          snyk test --severity-threshold=high || true
          snyk fix || true

      - name: Run tests after security fixes
        run: npm test
        continue-on-error: true

      - name: Create Security Update PR
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'fix(security): apply security updates'
          title: 'Security Updates - Automated Fix'
          body: |
            ## Security Updates Applied
            
            This PR contains automated security fixes for vulnerable dependencies.
            
            ### Security Fixes
            - Applied npm audit fixes
            - Resolved high/critical vulnerabilities
            
            ### Important
            Please review these changes carefully before merging.
            
            **Generated by GitHub Actions**
          branch: automated-security-updates
          delete-branch: true
          labels: security, dependencies, automated, priority-high

  update-report:
    name: Generate Update Report
    runs-on: ubuntu-latest
    needs: [check-updates, update-minor-patches, security-updates]
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate summary report
        run: |
          echo "# Dependency Update Report" > report.md
          echo "Date: $(date)" >> report.md
          echo "" >> report.md
          echo "## Summary" >> report.md
          echo "- Check Updates: ${{ needs.check-updates.result }}" >> report.md
          echo "- Minor/Patch Updates: ${{ needs.update-minor-patches.result }}" >> report.md
          echo "- Security Updates: ${{ needs.security-updates.result }}" >> report.md
          echo "" >> report.md
          echo "Review pull requests for detailed changes." >> report.md

      - name: Upload report
        uses: actions/upload-artifact@v4
        with:
          name: dependency-update-report
          path: report.md
          retention-days: 90